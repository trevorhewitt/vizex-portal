<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Drawing</title>
  <link rel="stylesheet" href="assets/style.css"/>
  <script src="assets/util.js" defer></script>
  <style>
    /* Scoped drawing-app styles (keeps global CSS intact) */
    #appRoot {
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:16px;
      user-select:none;
      -webkit-user-select:none;
      -ms-user-select:none;
      width:100%;
    }
    #appRoot .controls,
    #appRoot #viewport {
      width: 450px;   /* visual size on the tablet */
      height: 450px;  /* must match width, to stay square */
    }

    #appRoot { --ui-scale: 1.45; --slider-track-h: 40px; --slider-thumb-d: 30px; --thumb-border: 4px solid #005197; }
    #appRoot #viewport{
      height:calc(350px * var(--ui-scale));
      overflow:hidden;
      border:2px solid green;
      position:relative;
      touch-action:none;
      margin-bottom:calc(20px * var(--ui-scale));
      display:flex; align-items:center; justify-content:center;
      background:#f0f0f0;
    }
    #appRoot canvas{
      position:absolute;
      width:950px; height:950px;
      cursor:crosshair; touch-action:none; user-select:none;
    }
    #appRoot .controls{ display:flex; flex-direction:column; gap:12px; text-transform:lowercase; }
    #appRoot .row{ display:flex; align-items:center; }
    #appRoot .space-between{ justify-content:space-between; }
    #appRoot .row.space-between{ align-items:end; }
    #appRoot .slider-group{
      flex:1; display:grid; grid-template-rows:auto var(--slider-track-h); align-items:end;
    }
    #appRoot .slider-group .label-text{ font-size:14px; margin-bottom:4px; justify-self:center; text-align:center; text-transform:lowercase; }
    #appRoot .slider-group input[type="range"]{ align-self:end; width:100%; }
    #appRoot .divider, #appRoot .col-divider{ pointer-events:none; background:#ccc; }
    #appRoot .divider{ width:1px; height:24px; margin:0 8px; }
    #appRoot .col-divider{ width:1px; margin:0 12px; }
    #appRoot .tool-row, #appRoot .actions{ display:flex; align-items:center; gap:8px; text-transform:lowercase; }
    #appRoot .tool-row button, #appRoot .actions button{
      flex:1; padding:8px; font-size:14px; background:#fff; border:1px solid #ccc;
      border-radius:10px;
    }
    #appRoot .tool-row button.selected, #appRoot .tool-row button.active{ background:#ddd; border-color:#888; }
    #appRoot #swapColors{
      align-self:end; height:var(--slider-track-h); min-height:0; width:50px; padding:0; border-radius:0; background:#fff; border:1px solid #ccc; color:inherit;
    }
    #appRoot #flipH{ background:#fff; border:1px solid #ccc; }
    #appRoot input[type="range"]{ -webkit-appearance:none; appearance:none; width:100%; height:var(--slider-track-h); background:none; }
    #appRoot input[type="range"]::-webkit-slider-runnable-track{
      height:var(--slider-track-h); background-size:100% 100%; background-repeat:no-repeat; background-position:center;
    }
    #appRoot input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none; appearance:none; width:var(--slider-thumb-d); height:var(--slider-thumb-d);
      margin-top:calc((var(--slider-track-h) - var(--slider-thumb-d))/2); border:var(--thumb-border); border-radius:50%;
      background:transparent; box-shadow:0 0 2px #888;
    }
    #appRoot input[type="range"]::-moz-range-track{
      height:var(--slider-track-h); background-size:100% 100%; background-repeat:no-repeat; background-position:center;
    }
    #appRoot input[type="range"]::-moz-range-thumb{
      width:var(--slider-thumb-d); height:var(--slider-thumb-d); border:var(--thumb-border); border-radius:50%; background:transparent; box-shadow:0 0 2px #888;
    }
    #appRoot input[type="range"]::-moz-range-progress{ background-color:transparent; }
    #appRoot input[type="range"]::-ms-track{
      height:var(--slider-track-h); background:transparent; border-color:transparent; color:transparent;
    }
    #appRoot input[type="range"]::-ms-thumb{
      width:var(--slider-thumb-d); height:var(--slider-thumb-d); border:var(--thumb-border); border-radius:50%; background:transparent; box-shadow:0 0 2px #888;
    }
    /* Slider track images (scoped) */
    #appRoot #background::-webkit-slider-runnable-track{ background:url('https://res.cloudinary.com/dlginribm/image/upload/v1756743258/colour_zes2mh.png') no-repeat center/cover; }
    #appRoot #brushColor::-webkit-slider-runnable-track{ background:url('https://res.cloudinary.com/dlginribm/image/upload/v1756743258/brightness_clear_z6urk1.png') no-repeat center/cover; }
    #appRoot #occludeCenter::-webkit-slider-runnable-track{ background:url('https://res-console.cloudinary.com/dlginribm/thumbnails/v1/image/upload/v1756743258/Y2VudHJlX2NsZWFyX3lzc3g5aw==/as_is') no-repeat center/cover; }
    #appRoot #occludeEdge::-webkit-slider-runnable-track{ background:url('https://res-console.cloudinary.com/dlginribm/thumbnails/v1/image/upload/v1756743258/ZWRnZV9jbGVhcl9qYnVkd2Y=/as_is') no-repeat center/cover; }
    #appRoot #blur::-webkit-slider-runnable-track{ background:url('https://res.cloudinary.com/dlginribm/image/upload/v1756743258/blur_clear_v2_j4ntub.png') no-repeat center/cover; }
    #appRoot #thickness::-webkit-slider-runnable-track{ background:url('https://res.cloudinary.com/dlginribm/image/upload/v1756743258/thickness_clear_kzsa5m.png') no-repeat center/cover; }
    #appRoot #background::-moz-range-track{ background:url('https://res.cloudinary.com/dlginribm/image/upload/v1756743258/colour_zes2mh.png') no-repeat center/cover; }
    #appRoot #brushColor::-moz-range-track{ background:url('https://res.cloudinary.com/dlginribm/image/upload/v1756743258/brightness_clear_z6urk1.png') no-repeat center/cover; }
    #appRoot #occludeCenter::-moz-range-track{ background:url('https://res-console.cloudinary.com/dlginribm/thumbnails/v1/image/upload/v1756743258/Y2VudHJlX2NsZWFyX3lzc3g5aw==/as_is') no-repeat center/cover; }
    #appRoot #occludeEdge::-moz-range-track{ background:url('https://res-console.cloudinary.com/dlginribm/thumbnails/v1/image/upload/v1756743258/ZWRnZV9jbGVhcl9qYnVkd2Y=/as_is') no-repeat center/cover; }
    #appRoot #blur::-moz-range-track{ background:url('https://res.cloudinary.com/dlginribm/image/upload/v1756743258/blur_clear_v2_j4ntub.png') no-repeat center/cover; }
    #appRoot #thickness::-moz-range-track{ background:url('https://res.cloudinary.com/dlginribm/image/upload/v1756743258/thickness_clear_kzsa5m.png') no-repeat center/cover; }

    /* Saving overlay (no text) */
    #savingOverlay{
      position:fixed; inset:0; background:rgba(0,0,0,0.25);
      display:none; z-index:9999;
    }
    /* Dev confirm dialog */
    #devConfirm{
      position:fixed; inset:0; background:rgba(0,0,0,0.4); display:none; z-index:9999;
      align-items:center; justify-content:center;
    }
    #devConfirm .panel{
      background:#fff; color:#111; padding:16px; border-radius:12px; width:min(90vw, 520px);
    }
    #devConfirm .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px; }
    #devConfirm button{ padding:10px 18px; border:none; border-radius:10px; }
    #devConfirm .cancel{ background:#ddd; }
    #devConfirm .ok{ background:#333; color:#fff; }
  </style>
</head>

<body data-page="drawing">
  <div class="page">
    <div class="content">
      <div class="inner" id="root">
        <div id="appRoot">
          <div id="viewport">
            <canvas id="drawingCanvas" width="1024" height="1024"></canvas>
          </div>

          <div class="controls">
            <div class="row space-between">
              <div class="slider-group">
                <span class="label-text">background colour</span>
                <input type="range" id="background" min="0" max="255" value="255"/>
              </div>
              <div class="divider"></div>
              <button id="swapColors">swap colours</button>
              <div class="divider"></div>
              <div class="slider-group">
                <span class="label-text">brush colour</span>
                <input type="range" id="brushColor" min="0" max="255" value="0"/>
              </div>
            </div>

            <div class="row">
              <div style="flex:1; display:flex; flex-direction:column; gap:12px;">
                <div class="slider-group" style="display:none;">
                  <span class="label-text">center fade</span>
                  <input type="range" id="occludeCenter" min="-1" max="1" step="0.01" value="0"/>
                </div>
                <div class="slider-group">
                  <span class="label-text">brush softness</span>
                  <input type="range" id="blur" min="0" max="10" step="0.1" value="0"/>
                </div>
              </div>

              <div class="col-divider"></div>

              <div style="flex:1; display:flex; flex-direction:column; gap:12px;">
                <div class="slider-group" style="display:none;">
                  <span class="label-text">edge fade</span>
                  <input type="range" id="occludeEdge" min="-1" max="1" step="0.01" value="0"/>
                </div>
                <div class="slider-group">
                  <span class="label-text">brush size</span>
                  <input type="range" id="thickness" min="1" max="20" value="10"/>
                </div>
              </div>
            </div>

            <div class="tool-row">
              <button data-tool="draw" class="selected">draw</button>
              <button data-tool="erase">erase</button>
              <div class="divider"></div>
              <button data-tool="move">move</button>
              <div class="divider"></div>
              <button id="flipH">flip</button>
            </div>

            <div class="actions">
              <button id="undo">undo</button>
              <button id="redo">redo</button>
              <button id="clear">clear</button>
              <div class="divider"></div>
              <button id="saveButton">finish</button>
            </div>
            <hr/>

            <div class="actions" id="devToolsRow">
              <div>Dev tools:</div>
              <button id="importVector">Import Vector</button>
              <button id="exportJson">Export JSON</button>
              <button id="importJson">Import JSON</button>
            </div>
          </div>
        </div>

        <div id="savingOverlay" aria-hidden="true"></div>
        <div id="devConfirm" role="dialog" aria-modal="true" aria-labelledby="devConfirmMsg">
          <div class="panel">
            <div id="devConfirmMsg">Participant - please click cancel and bring your tablet to the researcher so they can fix this error</div>
            <div class="actions">
              <button class="cancel" id="devCancel">Cancel</button>
              <button class="ok" id="devOk">OK</button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="footer">
      <div class="button-bar">
        <button id="backBtn" class="secondary">Back</button>
        <button id="nextBtn" class="primary">Next</button>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const params = VE.parseParams();
      const dev = VE.hasDev(params);

      // Footer nav visibility (dev-only)
      const back = document.getElementById("backBtn");
      const next = document.getElementById("nextBtn");
      back.style.display = dev ? "" : "none";
      next.style.display = dev ? "" : "none";

      // Back uses normal route
      back?.addEventListener("click", () => {
        const r = VE.backRoute("drawing", params);
        VE.goto(r.page, r.params);
      });

      // Dev Next: confirm, then skip saving on OK
      next?.addEventListener("click", () => {
        if (!dev) return;
        const dlg = document.getElementById("devConfirm");
        dlg.style.display = "flex";
      });
      document.getElementById("devCancel").addEventListener("click", () => {
        document.getElementById("devConfirm").style.display = "none";
      });
      document.getElementById("devOk").addEventListener("click", () => {
        document.getElementById("devConfirm").style.display = "none";
        const r = VE.nextRoute("drawing", params);
        VE.goto(r.page, r.params); // dev: proceed without saving
      });

      // Show/hide developer tools row inside app
      const devRow = document.getElementById("devToolsRow");
      devRow.style.display = dev ? "" : "none";

      // Helpers for the saving overlay (used by onSave)
      window.__VE_showSaving = function(){
        const o = document.getElementById("savingOverlay");
        if (o) o.style.display = "block";
      };
      window.__VE_hideSaving = function(){
        const o = document.getElementById("savingOverlay");
        if (o) o.style.display = "none";
      };

      // Dev footer readout only in dev
      VE.renderDevFooter(params, dev ? "drawing (dev)" : "");
    });
  </script>
</body>
</html>
