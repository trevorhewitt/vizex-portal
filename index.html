<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>RESEARCHER USE ONLY — parameters input</title>
  <link rel="stylesheet" href="assets/style.css" />
  <script src="assets/util.js" defer></script>
  <style>
    .hint {
      font-size: 12px;
      opacity: 0.75;
      display: block;
      margin-top: 4px;
    }
    .inline-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .linklike {
      background: none;
      border: none;
      padding: 0;
      font: inherit;
      color: var(--accent, #0b5fff);
      text-decoration: underline;
      cursor: pointer;
    }
  </style>
</head>
<body data-page="index">
  <div class="page">
    <div class="content">
      <div class="inner">
        <h1>RESEARCHER USE ONLY — parameters input</h1>

        <div class="form-grid">
          <label>
            Session
            <select id="sessionSelect" aria-label="session"></select>
          </label>

          <label>
            Participant preferred name (display only)
            <input type="text" id="nameInput" inputmode="text" autocomplete="off" />
          </label>

          <label>
            Participant code (saved)
            <input type="text" id="codeInput" inputmode="text" autocomplete="off" />
          </label>

          <label>
            Trial order (string of condition characters; auto-fills from session; editable)
            <div class="inline-actions">
              <input type="text" id="orderInput" inputmode="text" autocomplete="off" style="flex:1;" />
              <button id="resetOrderBtn" class="linklike" type="button" title="Reset to the session’s default order">reset</button>
            </div>
            <span class="hint">Changing session will fill this if it’s empty or still on the last auto-filled value. Typing here creates a manual override that is preserved.</span>
          </label>

          <label>
            Current trial index (integer; default 0)
            <input type="text" id="indexInput" value="0" inputmode="numeric" />
          </label>

          <label>
            Mode
            <select id="modeSelect" aria-label="mode">
              <option value="0" selected>Experiment (m=0)</option>
              <option value="1">Dev mode (m=1)</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="button-bar">
        <button id="nextBtn" class="primary">Next</button>
      </div>
    </div>
  </div>

  <script>
    // Fixed, pre-generated orders
    const SESSION_ORDERS = {
      "202510170920": "D72B2XC4534AX566311",
      "202510171100": "D42C1X166B53X253A74",
      "202510171240": "D2535X24616AX7C134B",
      "202510171420": "D514CX426235X7A3B16",
      "202510171600": "D321BX1C6255X44673A",
      "202510180920": "DB112X3436CAX764255",
      "202510181100": "D4153X24B563X267AC1",
      "202510181240": "D7165XAB1426X33C542",
      "202510181420": "D13A5X1362B2XC76454",
      "202510181600": "D5137X1C344AX622B65",
      "202510240920": "D44CBX526635XA31721",
      "202510241100": "D2326XBA7415X5C6314",
      "202510241240": "DB45CX715A23X621634",
      "202510241420": "D1526X347645XC123AB",
      "202510241600": "D51B6X47A2C3X431625",
      "202510241740": "D64A3X721B5CX245613",
    };

    // Ensure VE exists and expose these for other pages if helpful
    window.VE = window.VE || {};
    VE.SESSION_ORDERS = SESSION_ORDERS;

    document.addEventListener("DOMContentLoaded", () => {
      // Guard: util.js should define VE.SESSIONS / VE.parseParams / VE.goto
      if (!window.VE || !VE.SESSIONS || !Array.isArray(VE.SESSIONS)) {
        console.error("VE.SESSIONS not found. Ensure util.js loaded before this inline script.");
      }

      const params = (VE.parseParams ? VE.parseParams() : {});

      const sel = document.getElementById("sessionSelect");
      const orderInput = document.getElementById("orderInput");
      const resetOrderBtn = document.getElementById("resetOrderBtn");

      // Keep track of the last value we auto-filled so we know when it's safe to overwrite
      let lastAutoOrder = "";

      // Populate sessions from VE.SESSIONS only (avoid referencing a bare SESSIONS symbol)
      (VE.SESSIONS || []).forEach(([label, code]) => {
        const opt = document.createElement("option");
        opt.value = code;
        opt.textContent = label;
        sel.appendChild(opt);
      });

      // If query specifies a session, select it
      if (params.s) {
        sel.value = params.s;
      }
      // If nothing is selected (e.g., missing/unknown code), default to the first session
      if (!sel.value && VE.SESSIONS && VE.SESSIONS.length > 0) {
        sel.value = VE.SESSIONS[0][1];
      }

      // Helper to compute the default order for the currently selected session
      function currentDefaultOrder() {
        const code = sel.value;
        return (VE.SESSION_ORDERS && VE.SESSION_ORDERS[code]) ? VE.SESSION_ORDERS[code] : "";
      }

      // Fill the order box if (a) empty OR (b) still equals the last auto value OR (c) force=true
      function applyDefaultOrder(force = false) {
        const def = currentDefaultOrder();
        const cur = orderInput.value.trim();

        if (force || cur === "" || cur === lastAutoOrder) {
          orderInput.value = def;
          lastAutoOrder = def;
        }
      }

      // Prefill other controls from query if provided
      if (params.n) document.getElementById("nameInput").value  = params.n;
      if (params.p) document.getElementById("codeInput").value  = params.p;
      if (typeof params.i === "string") document.getElementById("indexInput").value = params.i;
      if (typeof params.m === "string") document.getElementById("modeSelect").value = params.m;

      // Decide initial trial order:
      // - If params.t provided and non-empty, respect it (manual override)
      // - Else, auto-fill from session default
      if (typeof params.t === "string" && params.t.trim().length > 0) {
        orderInput.value = params.t.trim();
        lastAutoOrder = currentDefaultOrder(); // remember what "auto" would be, so future session changes don't clobber unless equal
      } else {
        applyDefaultOrder(true);
      }

      // On any manual edit, we stop auto-overwriting until reset or the value returns to lastAutoOrder
      orderInput.addEventListener("input", () => {
        // No flag needed; logic checks value vs lastAutoOrder
      });

      // Changing session: fill only if empty or still auto
      sel.addEventListener("change", () => {
        applyDefaultOrder(false);
      });

      // Reset to the default for the selected session (force overwrite)
      resetOrderBtn.addEventListener("click", (e) => {
        e.preventDefault();
        applyDefaultOrder(true);
      });

      // Next → param-check.html with built query
      document.getElementById("nextBtn").addEventListener("click", () => {
        const nextParams = {
          p: document.getElementById("codeInput").value.trim(),
          n: document.getElementById("nameInput").value.trim(),
          s: sel.value,
          t: orderInput.value.trim(),
          i: String(parseInt(document.getElementById("indexInput").value || "0", 10) || 0),
          m: document.getElementById("modeSelect").value
        };
        VE.goto("param-check.html", nextParams);
      });

      // Optional dev footer
      if (VE.renderDevFooter) VE.renderDevFooter(params, "index");
    });
  </script>
</body>
</html>
