<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>RESEARCHER USE ONLY — parameters input</title>
  <link rel="stylesheet" href="assets/style.css" />
  <script src="assets/util.js" defer></script>
</head>
<body data-page="index">
  <div class="page">
    <div class="content">
      <div class="inner">
        <h1>RESEARCHER USE ONLY — parameters input</h1>

        <div class="form-grid">
          <label>
            Session
            <select id="sessionSelect" aria-label="session"></select>
          </label>

          <label>
            Participant preferred name (display only)
            <input type="text" id="nameInput" inputmode="text" autocomplete="off" />
          </label>

          <label>
            Participant code (saved)
            <input type="text" id="codeInput" inputmode="text" autocomplete="off" />
          </label>

          <label>
            Trial order (string of condition characters; autoloads from session; manual edits override)
            <input type="text" id="orderInput" inputmode="text" autocomplete="off" />
          </label>

          <label>
            Current trial index (integer; default 0)
            <input type="text" id="indexInput" value="0" inputmode="numeric" />
          </label>

          <label>
            Mode
            <select id="modeSelect" aria-label="mode">
              <option value="0" selected>Experiment (m=0)</option>
              <option value="1">Dev mode (m=1)</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="button-bar">
        <button id="nextBtn" class="primary">Next</button>
      </div>
    </div>
  </div>

  <script>
    // Session → default trial-order mapping
    const SESSION_ORDERS = {
      "202510170920": "D72B2XC4534AX566311",
      "202510171100": "D42C1X166B53X253A74",
      "202510171240": "D2535X24616AX7C134B",
      "202510171420": "D514CX426235X7A3B16",
      "202510171600": "D321BX1C6255X44673A",
      "202510180920": "DB112X3436CAX764255",
      "202510181100": "D4153X24B563X267AC1",
      "202510181240": "D7165XAB1426X33C542",
      "202510181420": "D13A5X1362B2XC76454",
      "202510181600": "D5137X1C344AX622B65",
      "202510240920": "D44CBX526635XA31721",
      "202510241100": "D2326XBA7415X5C6314",
      "202510241240": "DB45CX715A23X621634",
      "202510241420": "D1526X347645XC123AB",
      "202510241600": "D51B6X47A2C3X431625",
      "202510241740": "D64A3X721B5CX245613",
    };

    document.addEventListener("DOMContentLoaded", () => {
      const params = VE.parseParams();

      const sel       = document.getElementById("sessionSelect");
      const nameInput = document.getElementById("nameInput");
      const codeInput = document.getElementById("codeInput");
      const orderInput= document.getElementById("orderInput");
      const indexInput= document.getElementById("indexInput");
      const modeSelect= document.getElementById("modeSelect");
      const nextBtn   = document.getElementById("nextBtn");

      // Track whether user has manually edited the trial order
      let manualOrderOverride = false;

      // Populate sessions (VE.SESSIONS is provided by util.js)
      VE.SESSIONS.forEach(([label, code]) => {
        const opt = document.createElement("option");
        opt.value = code;
        opt.textContent = label;
        sel.appendChild(opt);
      });

      // Helper to apply default trial order for the selected session,
      // but only if the user hasn't manually overridden it
      function applyDefaultOrderIfAllowed() {
        if (manualOrderOverride) return;
        const sessionCode = sel.value;
        const defaultOrder = SESSION_ORDERS[sessionCode] || "";
        orderInput.value = defaultOrder;
      }

      // Prefill from query (if any)
      if (params.s) sel.value = params.s;
      if (params.n) nameInput.value = params.n;
      if (params.p) codeInput.value = params.p;
      if (params.i) indexInput.value = params.i;
      if (params.m) modeSelect.value = params.m;

      // If t provided in query, it's a manual override
      if (typeof params.t === "string") {
        orderInput.value = params.t;
        manualOrderOverride = true;
      } else {
        // otherwise, apply the default from currently selected session (if any)
        applyDefaultOrderIfAllowed();
      }

      // When session changes, refresh trial order unless user has overridden
      sel.addEventListener("change", () => {
        applyDefaultOrderIfAllowed();
      });

      // Mark manual override if user types in the order field
      orderInput.addEventListener("input", () => {
        manualOrderOverride = true;
      });

      // Build query and go to param-check.html
      nextBtn.addEventListener("click", () => {
        const nextParams = {
          p: codeInput.value.trim(),
          n: nameInput.value.trim(),
          s: sel.value,
          t: orderInput.value.trim(),
          i: String(parseInt(indexInput.value || "0", 10) || 0),
          m: modeSelect.value
        };
        VE.goto("param-check.html", nextParams);
      });

      // Optional dev footer (as in your original)
      VE.renderDevFooter(params, "index");
    });
  </script>
</body>
</html>
